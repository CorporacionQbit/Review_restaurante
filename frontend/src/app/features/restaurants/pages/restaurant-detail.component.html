<div class="restaurant-detail-page">
  <div class="restaurant-detail-container">

    <!-- ================= HEADER ================= -->
    <section class="restaurant-header">

      <div class="header-top">
        <h1 class="restaurant-title">
          {{ restaurant?.name }}
        </h1>

        <!-- â¤ï¸ FAVORITO (solo clientes logueados) -->
        <div
          class="favorite-btn"
          *ngIf="isLoggedIn()"
          [class.active]="isFavorite"
          (click)="toggleFavorite()"
          title="Agregar a favoritos">
          <span *ngIf="!isFavorite">ğŸ¤</span>
          <span *ngIf="isFavorite">â¤ï¸</span>
        </div>
      </div>

      <div class="restaurant-meta">
        <nz-rate [ngModel]="restaurant?.avgRating" nzDisabled></nz-rate>
        <span>
          {{ restaurant?.avgRating || 0 }} Â· {{ restaurant?.totalReviews }} reseÃ±as
        </span>

        <span *ngIf="restaurant?.isPremium" class="badge-premium">
          â­ Premium
        </span>

        <span
          class="badge-status"
          [ngClass]="restaurant?.onboardingStatus?.toLowerCase()">
          {{ restaurant?.onboardingStatus }}
        </span>
      </div>

      <p class="restaurant-description">
        {{ restaurant?.description || 'Sin descripciÃ³n disponible' }}
      </p>

      <button class="cta-btn" (click)="scrollToReviews()">
        Ver reseÃ±as
      </button>
    </section>

    <!-- ================= HERO ================= -->
    <section class="hero">
      <div
        class="hero-image"
        *ngIf="restaurant?.images?.length > 0; else noHero"
        [style.backgroundImage]="'url(http://localhost:3000/' + restaurant.images[0].imageUrl + ')'">
      </div>

      <ng-template #noHero>
        <div class="hero-placeholder">
          {{ restaurant?.name?.charAt(0) }}
        </div>
      </ng-template>
    </section>

    <!-- ================= INFO ================= -->
    <section class="restaurant-info">

      <div class="info-item">
        <span class="icon">ğŸ“</span>
        <div>
          <strong>UbicaciÃ³n</strong>
          <p>
            {{ restaurant?.address }}
            <span *ngIf="restaurant?.city"> Â· {{ restaurant.city }}</span>
            <span *ngIf="restaurant?.zone"> (Zona {{ restaurant.zone }})</span>
          </p>
        </div>
      </div>

      <div class="info-item">
        <span class="icon">ğŸ’°</span>
        <div>
          <strong>Rango de precios</strong>
          <p>
            {{ restaurant?.priceRange ? ('$'.repeat(restaurant.priceRange)) : 'No especificado' }}
          </p>
        </div>
      </div>

      <div class="info-item" *ngIf="restaurant?.phoneNumber">
        <span class="icon">ğŸ“</span>
        <p>{{ restaurant.phoneNumber }}</p>
      </div>

      <div class="info-item" *ngIf="restaurant?.email">
        <span class="icon">âœ‰ï¸</span>
        <p>{{ restaurant.email }}</p>
      </div>

    </section>

    <!-- ================= CONTENT ================= -->
    <div class="content">

      <!-- MAIN -->
      <main class="main">

        <!-- ================= GALERÃA ================= -->
        <section class="gallery-section" *ngIf="restaurant?.images?.length">
          <h2>GalerÃ­a</h2>

          <div class="gallery-grid">
            <div
              class="gallery-item"
              *ngFor="let img of restaurant.images; let i = index"
              [style.backgroundImage]="'url(http://localhost:3000/' + img.imageUrl + ')'"
              (click)="openImage(i)">
              <div class="overlay">Ver</div>
            </div>
          </div>
        </section>

        <!-- ================= POSTS (PREMIUM) ================= -->
        <section
          class="posts-section"
          *ngIf="restaurant?.isPremium && posts?.length">

          <h2>Novedades</h2>

          <div class="post-card" *ngFor="let p of posts">
            <h3>{{ p.title }}</h3>
            <p>{{ p.content }}</p>

            <img
              *ngIf="p.imageUrl"
              [src]="'http://localhost:3000/' + p.imageUrl"
              alt="Imagen del post" />

            <span class="post-date">
              {{ p.createdAt | date:'mediumDate' }}
            </span>
          </div>

        </section>

        <!-- ================= RESEÃ‘AS ================= -->
        <section class="reviews-section" #reviewsSection>
          <h2>Opiniones de clientes ({{ reviews.length }})</h2>

          <div class="review-card" *ngFor="let r of reviews">
            <div class="avatar">
              {{ r.user?.fullName?.charAt(0) || 'U' }}
            </div>

            <div class="review-content">
              <div class="review-header">
                <strong>{{ r.user?.fullName || 'Usuario' }}</strong>
                <nz-rate [ngModel]="r.rating" nzDisabled></nz-rate>
              </div>

              <p>{{ r.reviewText || 'Sin comentario' }}</p>
              <span class="date">
                {{ r.createdAt | date:'mediumDate' }}
              </span>
            </div>
          </div>

          <div class="empty" *ngIf="reviews.length === 0">
            AÃºn no hay reseÃ±as
          </div>
        </section>

        <!-- ================= FORMULARIO RESEÃ‘A ================= -->
        <section class="review-form">

          <h3>CuÃ©ntanos tu experiencia</h3>

          <!-- NO LOGUEADO -->
          <div *ngIf="!isLoggedIn()" class="login-box">
            <p>Debes iniciar sesiÃ³n para escribir una reseÃ±a.</p>
            <button
              nz-button
              nzType="primary"
              (click)="router.navigate(['/auth/login'], { queryParams: { redirect: router.url } })">
              Iniciar sesiÃ³n
            </button>
          </div>

          <!-- LOGUEADO PERO NO APROBADO -->
          <div
            *ngIf="isLoggedIn() && restaurant?.onboardingStatus !== 'Aprobado'"
            class="blocked-box">
            <p>
              Este restaurante aÃºn no ha sido aprobado para recibir reseÃ±as.
            </p>
          </div>

          <!-- LOGUEADO Y APROBADO -->
          <div
            *ngIf="isLoggedIn() && restaurant?.onboardingStatus === 'Aprobado'">

            <label>CalificaciÃ³n</label>
            <nz-rate [(ngModel)]="rating"></nz-rate>

            <label>Comentario</label>
            <textarea
              nz-input
              rows="4"
              [(ngModel)]="reviewText"
              placeholder="Â¿CÃ³mo fue tu experiencia?">
            </textarea>

            <button
              nz-button
              nzType="primary"
              (click)="submitReview()">
              Publicar reseÃ±a
            </button>
          </div>

        </section>

      </main>

      <!-- ================= SIDEBAR ================= -->
      <aside class="sidebar">

        <!-- MAPA (SOLO PREMIUM) -->
        <div
          class="sidebar-box map"
          *ngIf="restaurant?.isPremium && safeMapUrl">
          <h4>UbicaciÃ³n</h4>
          <iframe [src]="safeMapUrl"></iframe>
        </div>

        <!-- MENÃš (SOLO PREMIUM) -->
        <div
          class="sidebar-box menu"
          *ngIf="restaurant?.isPremium && restaurant?.menus?.length">
          <h4>MenÃº</h4>

          <div class="menu-card" *ngFor="let m of restaurant.menus">
            <div class="menu-icon">ğŸ½ï¸</div>
            <div class="menu-info">
              <strong>MenÃº del restaurante</strong>
              <span>Ver menÃº completo</span>
            </div>
            <a class="menu-action" [href]="m.menuUrl" target="_blank">
              Ver
            </a>
          </div>
        </div>

        <!-- MENSAJE SI NO ES PREMIUM -->
        <div
          class="sidebar-box locked"
          *ngIf="!restaurant?.isPremium">
          <p>ğŸ”’ Funciones Premium disponibles</p>
        </div>

        <!-- BADGE PREMIUM -->
        <div class="sidebar-premium" *ngIf="restaurant?.isPremium">
          â­ Restaurante Premium
        </div>

      </aside>
    </div>

    <!-- ================= LIGHTBOX ================= -->
    <div class="lightbox" *ngIf="activeImageIndex !== null">
      <div class="lightbox-backdrop" (click)="closeImage()"></div>

      <div class="lightbox-content">
        <img
          [src]="'http://localhost:3000/' + restaurant.images[activeImageIndex].imageUrl" />

        <button class="lightbox-close" (click)="closeImage()">âœ•</button>
        <button class="lightbox-prev" (click)="prevImage()">â€¹</button>
        <button class="lightbox-next" (click)="nextImage()">â€º</button>
      </div>
    </div>

  </div>
</div>
